{
  "name": "Get Crew Details Tool",
  "nodes": [
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "applicant_id",
              "type": "number"
            },
            {
              "name": "applicant_name"
            },
            {
              "name": "info_type"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "e011a43c-9bf3-4575-b0b8-bfc7e7fedc41",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  p.applicant_id,\n  CONCAT(\n    COALESCE(p.fname, ''), ' ',\n    COALESCE(p.mname, ''), ' ',\n    COALESCE(p.lname, ''), ' ',\n    COALESCE(p.suffix, '')\n  ) AS full_name,\n  p.fname,\n  p.mname,\n  p.lname,\n  p.suffix,\n  p.status,\n  p.email,\n  p.telephone1,\n  p.address1a,\n  p.address1b,\n  p.birthdate,\n  p.birthplace,\n  p.civil_status,\n  CASE \n    WHEN p.sex = 'M' THEN 'Male'\n    WHEN p.sex = 'F' THEN 'Female'\n  END AS sex,\n  p.nationality,\n  CASE \n    WHEN p.currentstate = 'I' THEN 'Inactive'\n    WHEN p.currentstate = 'A' THEN 'Active'\n    WHEN p.currentstate = 'RT' THEN 'Retired'\n    WHEN p.currentstate = 'NR' THEN 'Not-for-Rehire'\n    WHEN p.currentstate = 'DC' THEN 'Deceased'\n  END AS current_state,\n  pos1.name AS primary_position,\n  pos2.name AS secondary_position,\n  \n  -- Deployment info\n  pr.vessel_id,\n  v.name AS vessel_name,\n  prin.name AS principal_name,\n  pr.embarkation,\n  pr.disembarkation,\n  pr.contract_term_mos,\n  pos3.name AS deployment_position\n\nFROM personal p\nLEFT JOIN positions pos1 ON p.position_id1 = pos1.position_id\nLEFT JOIN positions pos2 ON p.position_id2 = pos2.position_id\nLEFT JOIN process pr ON p.applicant_id = pr.applicant_id\nLEFT JOIN vessels v ON pr.vessel_id = v.vessel_id\nLEFT JOIN principals prin ON pr.principal_id = prin.principal_id\nLEFT JOIN positions pos3 ON pr.position_id = pos3.position_id\n\nWHERE p.applicant_id = {{ $json.applicant_id }}\nLIMIT 1",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        224,
        0
      ],
      "id": "208b9c20-fe48-4494-8c00-bdfdee25e423",
      "name": "Get Personal & Deployment Info",
      "credentials": {
        "mySql": {
          "id": "ZTkr3Q1ezOlzmAfP",
          "name": "IRIS_Database"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9f905c78-70a2-43c4-9148-0ba41147f044",
              "name": "personal_data",
              "value": "={{ JSON.stringify($json) }}",
              "type": "string"
            },
            {
              "id": "e28b83c1-9bd8-4ec5-add2-b03c472559c8",
              "name": "applicant_id",
              "value": "={{ $json.applicant_id }}",
              "type": "string"
            },
            {
              "id": "4586040b-71f8-418d-9ec2-8b7f99181988",
              "name": "info_type",
              "value": "=={{ $parameter.info_type || 'all' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        448,
        0
      ],
      "id": "d7ac5544-b4b0-492e-8c60-77e21cc99ff7",
      "name": "Store Personal Info"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  'Training' AS category,\n  t.traindesc AS document_name,\n  t.issue_date,\n  t.expiry_date,\n  CASE \n    WHEN t.expiry_date = '0000-00-00' THEN 'No Expiry'\n    WHEN t.expiry_date < CURDATE() THEN 'Expired'\n    WHEN t.expiry_date <= DATE_ADD(CURDATE(), INTERVAL 90 DAY) THEN 'Expiring Soon'\n    ELSE 'Valid'\n  END AS status\nFROM training t\nWHERE t.applicant_id = {{ $json.applicant_id }}\n  AND t.archive = 0\n\nUNION ALL\n\nSELECT \n  'License' AS category,\n  l.name AS document_name,\n  al.issue_date,\n  al.expiry_date,\n  CASE \n    WHEN al.expiry_date = '0000-00-00' THEN 'No Expiry'\n    WHEN al.expiry_date < CURDATE() THEN 'Expired'\n    WHEN al.expiry_date <= DATE_ADD(CURDATE(), INTERVAL 90 DAY) THEN 'Expiring Soon'\n    ELSE 'Valid'\n  END AS status\nFROM applicant_licenses al\nLEFT JOIN licenses l ON al.license_id = l.id\nWHERE al.applicant_id = {{ $json.applicant_id }}\n  AND al.archive = 0\n\nUNION ALL\n\nSELECT \n  'Document' AS category,\n  d.name AS document_name,\n  ad.issue_date,\n  ad.expiry_date,\n  CASE \n    WHEN ad.expiry_date = '0000-00-00' THEN 'No Expiry'\n    WHEN ad.expiry_date < CURDATE() THEN 'Expired'\n    WHEN ad.expiry_date <= DATE_ADD(CURDATE(), INTERVAL 90 DAY) THEN 'Expiring Soon'\n    ELSE 'Valid'\n  END AS status\nFROM applicant_documents ad\nLEFT JOIN documents d ON ad.doc_id = d.id\nWHERE ad.applicant_id = {{ $json.applicant_id }}\n  AND ad.archive = 0\n\nUNION ALL\n\nSELECT \n  'Medical' AS category,\n  'Medical Certificate' AS document_name,\n  m.issue_date,\n  m.expiry_date,\n  CASE \n    WHEN m.expiry_date = '0000-00-00' THEN 'No Expiry'\n    WHEN m.expiry_date < CURDATE() THEN 'Expired'\n    WHEN m.expiry_date <= DATE_ADD(CURDATE(), INTERVAL 90 DAY) THEN 'Expiring Soon'\n    ELSE 'Valid'\n  END AS status\nFROM medical m\nWHERE m.applicant_id = {{ $json.applicant_id }}\n  AND m.archive = 0\n\nORDER BY category, expiry_date",
        "options": {}
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.5,
      "position": [
        672,
        0
      ],
      "id": "abac1dfd-e4de-4e7a-bf8e-aa6cedf05860",
      "name": "Get Document Status",
      "credentials": {
        "mySql": {
          "id": "ZTkr3Q1ezOlzmAfP",
          "name": "IRIS_Database"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        896,
        0
      ],
      "id": "3fc0f82f-db0d-43b3-a438-9c99e8667a23",
      "name": "Aggregate Documents"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6865007f-5258-4bd2-bdee-f8a79f54b277",
              "name": "documents_json",
              "value": "={{ JSON.stringify($input.all().map(i => i.json)) }}",
              "type": "string"
            },
            {
              "id": "7a6b6ed8-362d-41cb-86f9-447745ad3460",
              "name": "personal_json",
              "value": "={{ $('Store Personal Info').first().json.personal_data }}",
              "type": "string"
            },
            {
              "id": "e3f4ebdc-d1db-41de-806b-2afe66206eab",
              "name": "info_type",
              "value": "={{ $('Store Personal Info').first().json.info_type }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1120,
        0
      ],
      "id": "c5795c9c-a943-41a7-92bd-3107c978e85f",
      "name": "Prepare Data for Formatting"
    },
    {
      "parameters": {
        "jsCode": "// Parse data from previous node\nconst personalData = JSON.parse($input.first().json.personal_json);\nconst documentsData = JSON.parse($input.first().json.documents_json);\nconst infoType = $input.first().json.info_type;\n\n// Helper function to format date\nfunction formatDate(dateStr) {\n  if (!dateStr || dateStr === '0000-00-00') return 'N/A';\n  try {\n    const date = new Date(dateStr);\n    return date.toLocaleDateString('en-PH', { \n      year: 'numeric', \n      month: 'short', \n      day: 'numeric',\n      timeZone: 'Asia/Manila'\n    });\n  } catch (e) {\n    return 'N/A';\n  }\n}\n\n// Build response\nlet response = `*${personalData.full_name}* (ID: ${personalData.applicant_id})\\n\\n`;\n\n// Personal Information\nif (infoType === 'all' || infoType === 'personal') {\n  response += `ðŸ“‹ *PERSONAL INFORMATION*\\n`;\n  response += `â€¢ Status: ${personalData.status || 'N/A'}\\n`;\n  response += `â€¢ State: ${personalData.current_state || 'N/A'}\\n`;\n  response += `â€¢ Primary Position: ${personalData.primary_position || 'N/A'}\\n`;\n  if (personalData.secondary_position) {\n    response += `â€¢ Secondary Position: ${personalData.secondary_position}\\n`;\n  }\n  response += `â€¢ Email: ${personalData.email || 'N/A'}\\n`;\n  response += `â€¢ Phone: ${personalData.telephone1 || 'N/A'}\\n`;\n  response += `â€¢ Birthday: ${formatDate(personalData.birthdate)}\\n`;\n  response += `â€¢ Birthplace: ${personalData.birthplace || 'N/A'}\\n`;\n  response += `â€¢ Sex: ${personalData.sex || 'N/A'}\\n`;\n  response += `â€¢ Civil Status: ${personalData.civil_status || 'N/A'}\\n`;\n  response += `â€¢ Nationality: ${personalData.nationality || 'N/A'}\\n`;\n  if (personalData.address1a || personalData.address1b) {\n    response += `â€¢ Address: ${personalData.address1a || ''} ${personalData.address1b || ''}\\n`;\n  }\n  response += `\\n`;\n}\n\n// Deployment Information\nif (infoType === 'all' || infoType === 'deployment') {\n  response += `ðŸš¢ *DEPLOYMENT INFORMATION*\\n`;\n  if (personalData.vessel_name) {\n    response += `â€¢ Vessel: ${personalData.vessel_name}\\n`;\n    response += `â€¢ Principal: ${personalData.principal_name || 'N/A'}\\n`;\n    response += `â€¢ Position: ${personalData.deployment_position || 'N/A'}\\n`;\n    response += `â€¢ Contract: ${personalData.contract_term_mos || 'N/A'} months\\n`;\n    response += `â€¢ Embarkation: ${formatDate(personalData.embarkation)}\\n`;\n    response += `â€¢ Disembarkation: ${formatDate(personalData.disembarkation)}\\n`;\n  } else {\n    response += `â€¢ No active deployment\\n`;\n  }\n  response += `\\n`;\n}\n\n// Document Status\nif (infoType === 'all' || infoType === 'documents') {\n  response += `ðŸ“„ *DOCUMENT STATUS*\\n`;\n  \n  if (!documentsData || documentsData.length === 0) {\n    response += `â€¢ No documents found\\n`;\n  } else {\n    const expired = documentsData.filter(d => d.status === 'Expired').length;\n    const expiring = documentsData.filter(d => d.status === 'Expiring Soon').length;\n    const valid = documentsData.filter(d => d.status === 'Valid').length;\n    \n    response += `â€¢ Total: ${documentsData.length} documents\\n`;\n    if (expired > 0) response += `â€¢ âš ï¸ Expired: ${expired}\\n`;\n    if (expiring > 0) response += `â€¢ â° Expiring Soon: ${expiring}\\n`;\n    if (valid > 0) response += `â€¢ âœ“ Valid: ${valid}\\n`;\n    response += `\\n`;\n    \n    const categories = ['Training', 'License', 'Document', 'Medical'];\n    categories.forEach(cat => {\n      const catDocs = documentsData.filter(d => d.category === cat);\n      if (catDocs.length > 0) {\n        response += `\\n*${cat}*\\n`;\n        catDocs.forEach(doc => {\n          const icon = doc.status === 'Expired' ? 'âš ï¸' : \n                      doc.status === 'Expiring Soon' ? 'â°' : 'âœ“';\n          response += `${icon} ${doc.document_name || 'Unknown'}\\n`;\n          response += `   Expires: ${formatDate(doc.expiry_date)} (${doc.status})\\n`;\n        });\n      }\n    });\n  }\n}\n\nreturn {\n  json: {\n    response_text: response,\n    crew_data: {\n      personal: personalData,\n      documents: documentsData,\n      summary: {\n        total_documents: documentsData.length,\n        expired_count: documentsData.filter(d => d.status === 'Expired').length,\n        expiring_count: documentsData.filter(d => d.status === 'Expiring Soon').length\n      }\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1344,
        0
      ],
      "id": "9c3f1782-3ed4-4116-b0dc-618f14e3db00",
      "name": "Format Response"
    }
  ],
  "pinData": {},
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Get Personal & Deployment Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Personal & Deployment Info": {
      "main": [
        [
          {
            "node": "Store Personal Info",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Personal Info": {
      "main": [
        [
          {
            "node": "Get Document Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Document Status": {
      "main": [
        [
          {
            "node": "Aggregate Documents",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate Documents": {
      "main": [
        [
          {
            "node": "Prepare Data for Formatting",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Data for Formatting": {
      "main": [
        [
          {
            "node": "Format Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "8a7ce7ed-4275-4756-8ecd-b49882c30094",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "833ff8930db72d7a0f274bb3f9fe76a232d6d1601cfd2eda8ac6fefd1c585259"
  },
  "id": "kyW4EO4JJUqNAXN8",
  "tags": []
}